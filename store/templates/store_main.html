{% extends "user_page.html" %}

{% block more_extra_style %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/store.css" type="text/css" media="screen" />
{% endblock %}

{% block extra_script_include %}
  <script src="https://checkout.stripe.com/v2/checkout.js"></script>
{% endblock %}

{% block main_content %}

<div class="row-fluid">
    
    <div class="span12">
        <h1 class="store-headline">It's Shoppy Time</h1>
                
        <div class="row-fluid">
            
            <div class="span10 offset1">
                <h2 class="section-header">Current Offers</h2>
                
                <div class="row-fluid">
                    
                    <div class="span12 clear-fluid-row" > </div>
                    
                    {% for offer in offer_list %}
                    <div class="span12 offer-container">
                        <div class="span4">
                            <img src="{{ offer.image }}" alt="offer-image" />
                        </div>
                        <div class="span8">
                            <h3>{{ offer.header_text }}</h3>
                            <ul>
                                {% if offer.description_line_1 != '' %}
                                    <li>{{ offer.description_line_1 }}</li>
                                {% endif %}
                                
                                {% if offer.description_line_2 != '' %}
                                    <li>{{ offer.description_line_2 }}</li>
                                {% endif %}
                                
                                {% if offer.description_line_3 != '' %}
                                    <li>{{ offer.description_line_3 }}</li>
                                {% endif %}
                                
                                {% if offer.description_line_4 != '' %}
                                    <li>{{ offer.description_line_4 }}</li>
                                {% endif %}
                                
                                {% if offer.description_line_5 != '' %}
                                    <li>{{ offer.description_line_5 }}</li>
                                {% endif %}
                            </ul>
                        </div>
                        
                        <form action="/charge" method="post">
                            <button id="buy-offer-{{ offer.id }}" class="buy-button">Buy</button>
                            <script>
                                imageUrl = '{{ offer.thumbnail_image }}';
                                
                                $('#buy-offer-{{ offer.id }}').click(function() {
                                    StripeCheckout.open({
                                        key : '{{ stripe_public_key }}',
                                        address : true,
                                        amount : '{{ offer.price }}',
                                        name : '{{ offer.buy_window_title }}',
                                        description : '{{ offer.buy_window_description }}',
                                        panelLabel : 'Pay Now: ',
                                        image : imageUrl,
                                        token : function(res) { 
                                            record_charge(res, {{ offer.id }}); 
                                        }
                                    });
                            
                                    return false;
                                }); 
                            </script>
                        </form>
                        
                        <div style="clear: both;">
                        </div>
                    </div>
                    {% endfor %}
                    
                    
                    <!-- 
                    <div class="span12 offer-container">
                        <div class="span4">
                            <img src="{{ STATIC_URL }}img/product/question-mark.jpg" alt="Who Knows?" />
                        </div>
                        <div class="span8">
                            <h3>And other things! Who knows?</h3>
                            <p>Have an idea for a healthy deal you'd like for us to secure for you? Let us know!</p>
                        </div>
                        
                        <button class="buy-button">Let them know</button>
                        
                        <div style="clear: both;">
                        </div>
                    </div> -->
                    
                    <h2 class="section-header">Coming Soon...</h2>
                    <span style="position: relative; top: -12px; left: 10px;">Select your favorite idea below:</span>
                    <div class="span12">
                        
                        <div id="idea1" class="span4 coming-soon-idea" onmousedown="idea_selected(1)">
                            <p>
                                {{ idea1.text }}
                            </p>
                        </div>
                        
                        <div id="idea2" class="span4 coming-soon-idea" onmousedown="idea_selected(2)">
                            <p>
                                {{ idea2.text }}
                            </p>    
                        </div>
                        
                        <div id="idea3" class="span4 coming-soon-idea" onmousedown="idea_selected(3)">
                            <p>
                                {{ idea3.text }}
                            </p>
                        </div>
                        
                        <div style="clear: both;">
                        </div>  
                    </div>
                </div>
                
            </div>
        </div>        
    </div>

</div>


<script type="text/javascript">

function record_charge(res, offer_id) {
    $.ajax({
        url: "store/record-charge",
        type: "POST",
        data: {
            offer_id : offer_id,
            stripe_token : res.id
        },
        success: function(data) {
            window.location = "/store/purchase-complete";
        },
        failure: function(data) {
            window.location = "/store/purchase-failed";
        }
    })
}

// Idea Selector Handler
function idea_selected(selected_idea_num) {
    // Reset all the ideas
    $('#idea1').removeClass("coming-soon-favorite");
    $('#idea2').removeClass("coming-soon-favorite");
    $('#idea3').removeClass("coming-soon-favorite");
    
    $('#idea1').addClass("coming-soon-idea");
    $('#idea2').addClass("coming-soon-idea");
    $('#idea3').addClass("coming-soon-idea");
    
    // Set just this 1 div to favorite
    $('#idea' + selected_idea_num).removeClass("coming-soon-idea");
    $('#idea' + selected_idea_num).addClass("coming-soon-favorite");
    
    $.ajax({
        url: "store/vote",
        type: "GET",
        data: {
            option1: {{ idea1.id }},
            option2: {{ idea2.id }},
            option3: {{ idea3.id }}, 
            selection: selected_idea_num
        }
    });
}
</script>
        
{% endblock %}
